<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hourly Activity Log</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; }
        /* ìŠ¬ë¼ì´ë” ìŠ¤íƒ€ì¼ ì»¤ìŠ¤í…€ */
        .range-slider { -webkit-appearance: none; width: 100%; height: 8px; border-radius: 5px; background: #e5e7eb; outline: none; }
        .range-slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 24px; height: 24px; border-radius: 50%; background: #4F46E5; cursor: pointer; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: transform 0.1s; }
        .range-slider::-webkit-slider-thumb:hover { transform: scale(1.1); }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center p-4">

    <div class="bg-white w-full max-w-md rounded-2xl shadow-xl overflow-hidden">
        <!-- Header -->
        <div class="bg-indigo-600 p-6 text-white relative overflow-hidden">
            <div class="absolute top-0 right-0 m-[-10px] opacity-10">
                <i class="fas fa-clock text-9xl"></i>
            </div>
            <h2 class="text-2xl font-bold mb-1 relative z-10">Time Tracker</h2>
            <p class="text-indigo-100 text-sm opacity-90 relative z-10">ì§€ë‚œ í™œë™ì„ ê¸°ë¡í•©ë‹ˆë‹¤.</p>
        </div>

        <!-- Form -->
        <form id="logForm" class="p-6 space-y-6">
            
            <!-- Date & Time Selection -->
            <div class="bg-gray-50 p-4 rounded-xl border border-gray-100">
                <!-- Date -->
                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">ğŸ“… ë‚ ì§œ</label>
                    <input type="date" id="date" class="w-full bg-white border-gray-200 rounded-lg text-gray-800 font-medium text-sm p-2.5 focus:ring-2 focus:ring-indigo-500 focus:outline-none" required>
                </div>

                <!-- Time Range Dropdowns -->
                <div class="grid grid-cols-2 gap-3 items-end">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">â° ì‹œì‘ ì‹œê°„</label>
                        <div class="relative">
                            <select id="startTimeSelect" class="w-full bg-white border-gray-200 rounded-lg text-gray-800 font-medium text-sm p-2.5 appearance-none focus:ring-2 focus:ring-indigo-500 focus:outline-none cursor-pointer">
                                <!-- Options will be generated by JS -->
                            </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500">
                                <i class="fas fa-chevron-down text-xs"></i>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-gray-400 font-bold pb-2">~</span>
                        <div class="w-full">
                            <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">ì¢…ë£Œ ì‹œê°„</label>
                            <div class="relative">
                                <select id="endTimeSelect" class="w-full bg-white border-gray-200 rounded-lg text-gray-800 font-medium text-sm p-2.5 appearance-none focus:ring-2 focus:ring-indigo-500 focus:outline-none cursor-pointer">
                                    <!-- Options will be generated by JS -->
                                </select>
                                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500">
                                    <i class="fas fa-chevron-down text-xs"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Activity Input -->
            <div>
                <label class="block text-sm font-bold text-gray-700 mb-2">ğŸ“ ë¬´ì—‡ì„ í•˜ì…¨ë‚˜ìš”?</label>
                <textarea id="activity" rows="3" placeholder="ì˜ˆ: n8n ì›Œí¬í”Œë¡œìš° í…ŒìŠ¤íŠ¸, ë…ì„œ, íšŒì˜" class="w-full border-2 border-gray-200 rounded-xl p-3 text-gray-700 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition resize-none bg-white" required></textarea>
            </div>

            <!-- Sliders -->
            <div class="grid grid-cols-2 gap-6">
                <!-- Satisfaction -->
                <div class="bg-white">
                    <div class="flex justify-between items-end mb-3">
                        <label class="text-sm font-bold text-gray-600">ğŸ˜Š ë§Œì¡±ë„</label>
                        <span id="satisfactionVal" class="text-white bg-indigo-500 px-2 py-0.5 rounded-md text-sm font-bold">3</span>
                    </div>
                    <input type="range" id="satisfaction" min="1" max="5" value="3" class="range-slider">
                    <div class="flex justify-between text-xs text-gray-400 mt-1">
                        <span>1</span><span>5</span>
                    </div>
                </div>
                <!-- Concentration -->
                <div class="bg-white">
                    <div class="flex justify-between items-end mb-3">
                        <label class="text-sm font-bold text-gray-600">ğŸ”¥ ì§‘ì¤‘ë„</label>
                        <span id="concentrationVal" class="text-white bg-indigo-500 px-2 py-0.5 rounded-md text-sm font-bold">3</span>
                    </div>
                    <input type="range" id="concentration" min="1" max="5" value="3" class="range-slider">
                    <div class="flex justify-between text-xs text-gray-400 mt-1">
                        <span>1</span><span>5</span>
                    </div>
                </div>
            </div>

            <!-- Emotion (Optional) -->
            <div>
                <label class="block text-sm font-bold text-gray-700 mb-2">ğŸ’­ ê°ì • í•œ ì¤„ (ì„ íƒ)</label>
                <input type="text" id="emotion" placeholder="í˜„ì¬ ê¸°ë¶„ì€ ì–´ë– ì‹ ê°€ìš”?" class="w-full border-2 border-gray-200 rounded-xl p-3 text-gray-700 focus:ring-2 focus:ring-indigo-500 focus:outline-none transition">
            </div>

            <!-- Submit Button -->
            <button type="submit" id="submitBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 rounded-xl transition duration-200 shadow-lg hover:shadow-xl transform active:scale-98 flex justify-center items-center group">
                <span class="group-hover:mr-2 transition-all">ê¸°ë¡ ì €ì¥í•˜ê¸°</span>
                <i class="fas fa-paper-plane opacity-0 group-hover:opacity-100 transition-all transform translate-x-[-10px] group-hover:translate-x-0"></i>
            </button>
        </form>
    </div>

    <script>
        // ==========================================
        // ì„¤ì •: n8n Webhook ê¸°ë³¸ URL
        // Secret KeyëŠ” URLì—ì„œ ê°€ì ¸ì˜µë‹ˆë‹¤.
        // ==========================================
        const N8N_WEBHOOK_BASE_URL = "https://n8n.findwaylab.com/webhook/time-logger";
        const N8N_PLAN_QUERY_URL = "https://n8n.findwaylab.com/webhook/get-plan";
    
        // ------------------------------------------
        // URLì—ì„œ Secret Key ì¶”ì¶œ
        // ------------------------------------------
        const urlParams = new URLSearchParams(window.location.search);
        const secretKey = urlParams.get('secret');

        // ==========================================
        // 0. ìº˜ë¦°ë” ê³„íšì„ ì¡°íšŒí•˜ì—¬ ì…ë ¥ í•„ë“œë¥¼ ì±„ìš°ëŠ” í•¨ìˆ˜
        // ==========================================
        async function fetchAndPopulateActivity(date, startTime, endTime) {
            const activityInput = document.getElementById('activity');
            if (!activityInput) return;
            
            // ë¡œë”© ìƒíƒœ í‘œì‹œ
            activityInput.placeholder = "ìº˜ë¦°ë” ì¼ì •ì„ ì¡°íšŒ ì¤‘...";
            activityInput.value = ""; 

            const finalWebhookUrl = `${N8N_PLAN_QUERY_URL}?secret=${secretKey}`;
            const timezoneOffset = "%2B09:00";
        
            try {
                const queryUrl = `${finalWebhookUrl}&startTime=${date}T${startTime}:00${timezoneOffset}&endTime=${date}T${endTime}:00${timezoneOffset}`;
                
                const response = await fetch(queryUrl, { method: 'GET' });
                
                if (!response.ok) {
                    throw new Error(`HTTP Error: ${response.status}`);
                }
                
                const data = await response.json();
                const activity = data.activity || ""; // Code ë…¸ë“œì—ì„œ ë°˜í™˜ëœ 'activity'
                
                if (activity) {
                    activityInput.value = activity;
                    activityInput.placeholder = "ì˜ˆ: n8n ì›Œí¬í”Œë¡œìš° í…ŒìŠ¤íŠ¸, ë…ì„œ, íšŒì˜";
                } else {
                    activityInput.placeholder = "ìº˜ë¦°ë”ì— ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤. ì§ì ‘ ê¸°ì…í•´ ì£¼ì„¸ìš”.";
                }
        
            } catch (error) {
                console.error("ìº˜ë¦°ë” ì¡°íšŒ ì˜¤ë¥˜:", error);
                activityInput.placeholder = "ìº˜ë¦°ë” ì¡°íšŒ ì‹¤íŒ¨. ì§ì ‘ ê¸°ì…í•´ ì£¼ì„¸ìš”.";
            }
        }

        // ==========================================
        // 1. ë“œë¡­ë‹¤ìš´ ì˜µì…˜ ìƒì„± ë° ì´ˆê¸°í™” ë¡œì§
        // ==========================================
        function generateTimeOptions() {
            const options = [];
            for (let h = 0; h < 24; h++) {
                for (let m of [0, 30]) {
                    const hour = String(h).padStart(2, '0');
                    const min = String(m).padStart(2, '0');
                    const timeValue = `${hour}:${min}`;
                    options.push(`<option value="${timeValue}">${timeValue}</option>`);
                }
            }
            // ì¢…ë£Œ ì‹œê°„ì—ëŠ” 24:00 (ë‹¤ìŒë‚  00:00) ê°œë…ì´ í•„ìš”í•  ìˆ˜ ìˆìœ¼ë‚˜, 
            // ì‹¬í”Œí•¨ì„ ìœ„í•´ 23:59 í˜¹ì€ ë‹¤ìŒë‚  ë¡œì§ì€ ì œì™¸í•˜ê³  00:00~23:30ìœ¼ë¡œ êµ¬ì„±
            return options.join('');
        }

        function initializeForm() {
            // 0) ë³´ì•ˆ ê²€ì‚¬: Secret Keyê°€ ì—†ìœ¼ë©´ í˜ì´ì§€ ë‚´ìš© ì‚­ì œ ë° ê²½ê³ 
            if (!secretKey || secretKey.length < 10) { // í‚¤ ê¸¸ì´ ê²€ì‚¬ ì¶”ê°€ (ì„ íƒ ì‚¬í•­)
                document.body.innerHTML = '<div class="flex flex-col items-center justify-center min-h-screen bg-gray-50 text-red-600 p-8"><i class="fas fa-lock text-5xl mb-4"></i><h1 class="text-xl font-bold">âŒ ì ‘ê·¼ ê¶Œí•œ ì—†ìŒ</h1><p class="text-gray-600 mt-2 text-center">ìœ íš¨í•œ Secret Keyê°€ URLì— í¬í•¨ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.</p></div>';
                return;
            }
            
            try {
                const now = new Date();

                // 1) ë‚ ì§œ ì„¤ì • (YYYY-MM-DD)
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const todayString = `${year}-${month}-${day}`;
                
                const dateInput = document.getElementById('date');
                if (dateInput) dateInput.value = todayString;

                // 2) ì‹œê°„ ì˜µì…˜ ìƒì„±
                const timeOptionsHTML = generateTimeOptions();
                const startTimeSelect = document.getElementById('startTimeSelect');
                const endTimeSelect = document.getElementById('endTimeSelect');
                
                startTimeSelect.innerHTML = timeOptionsHTML;
                endTimeSelect.innerHTML = timeOptionsHTML;

                // 3) ìŠ¤ë§ˆíŠ¸ ê¸°ë³¸ê°’ ì„¤ì • (í˜„ì¬ ì‹œê°„ ê¸°ì¤€ ì§ì „ íƒ€ì„ë¸”ë¡)
                // ì˜ˆ: 14:15 ì ‘ì† -> ì‹œì‘ 13:30 / ì¢…ë£Œ 14:00 (ë˜ëŠ” 14:00~14:30 ë“± ì •ì±…ì— ë”°ë¼)
                // ì—¬ê¸°ì„œëŠ” "ì§€ë‚œ 1ì‹œê°„"ì´ ì•„ë‹Œ "í˜„ì¬ ì‹œì ê³¼ ê°€ì¥ ê°€ê¹Œìš´ 30ë¶„ ë‹¨ìœ„"ë¡œ ì„¤ì •
                
                let currentH = now.getHours();
                let currentM = now.getMinutes();
                
                // ê³„ì‚° í¸ì˜ë¥¼ ìœ„í•œ ë¶„ ë‹¨ìœ„ ì •ê·œí™” (0 ë˜ëŠ” 30)
                let targetEndM = currentM >= 30 ? 30 : 0;
                let targetEndH = currentH;
                
                // ì¢…ë£Œ ì‹œê°„ ë¬¸ìì—´
                let endHStr = String(targetEndH).padStart(2, '0');
                let endMStr = String(targetEndM).padStart(2, '0');
                let endTimeValue = `${endHStr}:${endMStr}`;

                // ì‹œì‘ ì‹œê°„ ê³„ì‚° (ì¢…ë£Œ ì‹œê°„ - 1ì‹œê°„)
                let targetStartH = targetEndH - 1;
                let targetStartM = targetEndM;
                
                // ìì • ë„˜ê¸°ëŠ” ê²½ìš° ì²˜ë¦¬ (0ì‹œì¸ ê²½ìš°)
                if (targetStartH < 0) {
                    targetStartH = 23;
                    // ë‚ ì§œëŠ” ê·¸ëŒ€ë¡œ ë‘¡ë‹ˆë‹¤ (ì‚¬ìš©ìê°€ ìˆ˜ì • ê°€ëŠ¥)
                }

                let startHStr = String(targetStartH).padStart(2, '0');
                let startMStr = String(targetStartM).padStart(2, '0');
                let startTimeValue = `${startHStr}:${startMStr}`;

                // ê°’ ì ìš©
                startTimeSelect.value = startTimeValue;
                endTimeSelect.value = endTimeValue;

                // ë§Œì•½ ìë™ ê³„ì‚°ëœ ê°’ì´ ì˜µì…˜ì— ì—†ë‹¤ë©´(ì˜ˆ: ì˜¤ë¥˜) ê¸°ë³¸ê°’ ìœ ì§€
                if(!startTimeSelect.value) startTimeSelect.selectedIndex = 0;
                if(!endTimeSelect.value) endTimeSelect.selectedIndex = 0;

                // ì´ˆê¸°ê°’ ì„¤ì • í›„ ìº˜ë¦°ë” ê³„íš ì¡°íšŒ (í˜ì´ì§€ ë¡œë“œ ì‹œ)
                if (dateInput.value && startTimeSelect.value && endTimeSelect.value) {
                    fetchAndPopulateActivity(dateInput.value, startTimeSelect.value, endTimeSelect.value);
                }
                
                // 4) ì‹œê°„ ë³€ê²½ ì‹œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                startTimeSelect.addEventListener('change', () => {
                    fetchAndPopulateActivity(dateInput.value, startTimeSelect.value, endTimeSelect.value);
                });
                
                endTimeSelect.addEventListener('change', () => {
                    fetchAndPopulateActivity(dateInput.value, startTimeSelect.value, endTimeSelect.value);
                });
                
                dateInput.addEventListener('change', () => {
                    fetchAndPopulateActivity(dateInput.value, startTimeSelect.value, endTimeSelect.value);
                });

            } catch (error) {
                console.error("ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
            }
        }

        // DOM ë¡œë“œ ì‹œ ì‹¤í–‰
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeForm);
        } else {
            initializeForm();
        }

        // ==========================================
        // 2. UI ì¸í„°ë™ì…˜ (ìŠ¬ë¼ì´ë”)
        // ==========================================
        function updateSlider(id, valId) {
            const el = document.getElementById(id);
            const valEl = document.getElementById(valId);
            if(el && valEl) {
                el.addEventListener('input', (e) => {
                    valEl.innerText = e.target.value;
                });
            }
        }
        updateSlider('satisfaction', 'satisfactionVal');
        updateSlider('concentration', 'concentrationVal');

        // ==========================================
        // 3. í¼ ì œì¶œ ë¡œì§
        // ==========================================
        document.getElementById('logForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            // 0) Secret Key ì¬í™•ì¸ (initializeFormì—ì„œ ì´ë¯¸ ë§‰ì•˜ì§€ë§Œ ì´ì¤‘ ì²´í¬)
            if (!secretKey) {
                Swal.fire({
                    icon: 'error',
                    title: 'ë³´ì•ˆ ì˜¤ë¥˜',
                    text: 'ìœ íš¨í•œ Secret Keyê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤. Discord ì•Œë¦¼ ë§í¬ë¥¼ í†µí•´ ì ‘ì†í•´ ì£¼ì„¸ìš”.',
                });
                return;
            }

            const startTime = document.getElementById('startTimeSelect').value;
            const endTime = document.getElementById('endTimeSelect').value;

            // ê°„ë‹¨í•œ ìœ íš¨ì„± ê²€ì‚¬: ì‹œì‘ ì‹œê°„ì´ ì¢…ë£Œ ì‹œê°„ë³´ë‹¤ ëŠ¦ìœ¼ë©´ ê²½ê³ 
            if (startTime >= endTime) {
                const result = await Swal.fire({
                    title: 'ì‹œê°„ í™•ì¸',
                    text: 'ì‹œì‘ ì‹œê°„ì´ ì¢…ë£Œ ì‹œê°„ë³´ë‹¤ ê°™ê±°ë‚˜ ëŠ¦ìŠµë‹ˆë‹¤. ê·¸ëŒ€ë¡œ ì €ì¥í• ê¹Œìš”?',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'ë„¤, ì €ì¥í•©ë‹ˆë‹¤',
                    cancelButtonText: 'ì•„ë‹ˆìš”, ìˆ˜ì •í• ê²Œìš”'
                });
                if (!result.isConfirmed) return;
            }

            const btn = document.getElementById('submitBtn');
            const originalHTML = btn.innerHTML;
            
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> ì €ì¥ ì¤‘...';
            btn.classList.add('opacity-75', 'cursor-not-allowed');

            // ë°ì´í„° êµ¬ì„±
            const formData = {
                date: document.getElementById('date').value,
                startTime: startTime,
                endTime: endTime,
                timeRange: `${startTime} ~ ${endTime}`, // n8n í¸ì˜ìš©
                activity: document.getElementById('activity').value,
                satisfaction: document.getElementById('satisfaction').value,
                concentration: document.getElementById('concentration').value,
                emotion: document.getElementById('emotion').value,
                timestamp: new Date().toISOString()
            };

            // **ì›¹í›… URLì— Secret Key ì¶”ê°€**
            const finalWebhookUrl = `${N8N_WEBHOOK_BASE_URL}?secret=${secretKey}`;

            try {
                const response = await fetch(finalWebhookUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    await Swal.fire({
                        icon: 'success',
                        title: 'ê¸°ë¡ ì™„ë£Œ!',
                        text: 'ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.',
                        timer: 2000,
                        showConfirmButton: false
                    });
                    document.getElementById('activity').value = '';
                    document.getElementById('emotion').value = '';
                    } else {
                        // n8nì—ì„œ 401 ì‘ë‹µì´ ì˜¤ë©´ ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼
                        if (response.status === 401) {
                            throw new Error('ì¸ì¦ ì‹¤íŒ¨: Secret Keyê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. Discord ì•Œë¦¼ ë§í¬ë¥¼ ë‹¤ì‹œ í™•ì¸í•˜ì„¸ìš”.');
                        }
                        throw new Error('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜ (HTTP Status: ' + response.status + ')');
                    }
                } catch (error) {
                    console.error('Submission Error:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'ì €ì¥ ì‹¤íŒ¨',
                        text: error.message.includes('ì¸ì¦ ì‹¤íŒ¨') ? error.message : 'n8n ì„œë²„ì™€ ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ì½˜ì†” í™•ì¸)',
                        footer: error.message.includes('ì¸ì¦ ì‹¤íŒ¨') ? '' : 'CORS ì„¤ì • ë˜ëŠ” n8n ì›¹í›… ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.'
                    });
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = originalHTML;
                    btn.classList.remove('opacity-75', 'cursor-not-allowed');
                }
            });
    </script>
</body>
</html>
